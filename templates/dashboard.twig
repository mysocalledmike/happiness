{% extends "layout.twig" %}

{% block body %}
{# Gradient Header Bar #}
{# Gradient Header Bar - Simplified to match prototype #}
<div class="gradient-header">
    <div class="gradient-header-content">
        <a href="/{% if company %}?company={{ company }}{% endif %}" class="logo">
            One Trillion Smiles
            <div class="logo-underline">
                <div class="logo-underline-line"></div>
                <div class="logo-sparkle">âœ¨</div>
                <div class="logo-underline-line"></div>
            </div>
        </a>
        {# User dropdown - matching prototype exactly #}
        <div style="position: relative;">
            <button onclick="toggleUserDropdown()" style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 9999px; border: none; color: white; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <span style="width: 2rem; height: 2rem; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">{{ sender.avatar }}</span>
                <span style="font-family: 'Poppins', sans-serif; font-size: 0.875rem; font-weight: 500; display: none;" class="user-name-desktop">{{ sender.name }}</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </button>
            <div id="user-dropdown" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; background: white; border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0,0,0,0.15); min-width: 200px; overflow: hidden; z-index: 1000;">
                <div style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                    <div style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--gray-900);">{{ sender.name }}</div>
                    <div style="font-family: 'Lora', serif; font-size: 0.875rem; color: var(--gray-600);">{{ sender.email }}</div>
                </div>
                <button onclick="signOut()" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; font-family: 'Lora', serif; font-size: 0.875rem; color: var(--gray-700); transition: background 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='none'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Sign out
                </button>
            </div>
        </div>
    </div>
</div>

<div class="page-gradient-bg">
    <div class="dashboard-container">
        {# Welcome Banner (First Visit) #}
        {% if first_visit %}
        <div class="banner banner-success">
            <button class="banner-close" onclick="this.parentElement.remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div style="width: 3rem; height: 3rem; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-family: 'Poppins', sans-serif; font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">Welcome to your private profile!</h4>
                    <p style="font-family: 'Lora', serif; color: var(--gray-700); margin-bottom: 0.75rem;">This page keeps track of the messages you've sent and how many people you've made smile. Check your email to confirm it's really you and to easily get back to this page.</p>
                    <p style="font-family: 'Lora', serif; font-size: 0.875rem; color: var(--gray-700); background: rgba(255,255,255,0.6); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #86efac;">
                        ðŸ”’ <strong>This is your private profile.</strong> Don't share this page's URL with othersâ€”it's only for you!
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        {# Email Confirmed Banner #}
        {% if confirmed %}
        <div class="banner banner-success">
            <button class="banner-close" onclick="this.parentElement.remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <h4>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Your email was confirmed
            </h4>
            <p>You can now send unlimited Smiles!</p>
        </div>
        {% endif %}

        {# Already Confirmed Banner #}
        {% if already_confirmed %}
        <div class="banner banner-info">
            <button class="banner-close" onclick="this.parentElement.remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <h4>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Email already confirmed
            </h4>
            <p>Your email is confirmed. You're all set!</p>
        </div>
        {% endif %}

        {# Smile Sent Banner (from quick send) #}
        {% if smile_sent %}
        <div class="banner banner-success">
            <button class="banner-close" onclick="this.parentElement.remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div style="width: 3rem; height: 3rem; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-family: 'Poppins', sans-serif; font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">Your message was sent! ðŸŽ‰</h4>
                    <p style="font-family: 'Lora', serif; color: var(--gray-700);">Use this private page to make more people smile - a link was also sent to your email.</p>
                </div>
            </div>
        </div>
        {% endif %}

        {# Dashboard Stats Card - Matching React Prototype #}
        <div class="dashboard-stats">
            {# Profile Section #}
            <div class="dashboard-stats-header">
                <div class="dashboard-stats-avatar">{{ sender.avatar }}</div>
                <div class="dashboard-stats-info">
                    <h1 class="dashboard-stats-name">{{ sender.name }}</h1>
                    <span class="dashboard-stats-email">{{ sender.email }}</span>
                </div>
            </div>

            {# Stats Grid #}
            <div class="dashboard-stats-grid">
                {# Messages Sent #}
                <div class="dashboard-stat">
                    <div class="dashboard-stat-header">
                        <div class="dashboard-stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                            </svg>
                        </div>
                        <h3 class="dashboard-stat-label">Messages sent</h3>
                    </div>
                    <div class="dashboard-stat-number" id="dashboard-user-count" data-value="{{ message_count|default(0) }}">0</div>
                </div>

                {# Smiles Created #}
                <div class="dashboard-stat">
                    <div class="dashboard-stat-header">
                        <div class="dashboard-stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </div>
                        <h3 class="dashboard-stat-label">Smiles created</h3>
                    </div>
                    <div class="dashboard-stat-number" id="dashboard-smiles-count" data-value="{{ smile_count }}">0</div>
                </div>

                {# Total Company Smiles - Clickable #}
                <div class="dashboard-stat clickable" id="company-smiles-stat" {% if company %}data-company="{{ company }}"{% endif %}>
                    <div class="dashboard-stat-header">
                        <div class="dashboard-stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
                            </svg>
                        </div>
                        <h3 class="dashboard-stat-label">Total {% if company %}{{ company_name }}{% else %}Company{% endif %} smiles</h3>
                    </div>
                    <div class="dashboard-stat-number" id="dashboard-company-count" data-value="{{ company_smiles|default(0) }}">0</div>
                </div>
            </div>
        </div>

        {# Masthead - Two Section Layout matching prototype exactly (Hidden in Variant B via CSS) #}
        <div class="masthead">
            {# Top Section - Smiles Count (gray background, centered) #}
            <div class="masthead-stats">
                <div class="masthead-stats-number">{{ smile_count }}</div>
                <p class="masthead-stats-label">smile{% if smile_count != 1 %}s{% endif %} created</p>
            </div>

            {# Bottom Section - Profile Info (white background, flex layout) #}
            <div class="masthead-profile">
                <div class="masthead-avatar">{{ sender.avatar }}</div>
                <div class="masthead-info">
                    <h1 class="masthead-name">{{ sender.name }}</h1>
                    <span class="masthead-email">{{ sender.email }}</span>
                </div>
            </div>
        </div>

        {# Send Smile Form or Confirmation Banner #}
        {% if not sender.email_confirmed and message_count >= 3 %}
            {# Blue Banner for Unconfirmed Users at Limit #}
            <div class="banner" style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; text-align: center;">
                <h4 style="color: white; margin-bottom: 12px;">We need to know it's really you!</h4>
                <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 16px;">Please check your email and confirm your address to send more smiles</p>
                <button onclick="requestConfirmationEmail()" class="btn btn-white">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Resend Confirmation Email
                </button>
            </div>
        {% else %}
            {# Regular Send Message Form #}
            <h3 class="section-heading">Make someone smile</h3>
            <div class="message-form-card">
                <form id="send-form">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" name="recipient_name" class="form-input" placeholder="Sarah" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="recipient_email" class="form-input" placeholder="sarah@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your message</label>
                        <textarea name="message" class="form-textarea" placeholder="Write something that will make them smile..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        Send smile
                    </button>
                </form>
            </div>
        {% endif %}

        {# Preview Confirmation Modal #}
        <div id="preview-modal" class="modal-overlay hidden">
            <div class="modal">
                <button class="modal-close" onclick="hidePreviewModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <div class="modal-header">
                    <div class="modal-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="modal-title">Confirm Message</h2>
                        <p class="modal-subtitle">Private message to <span id="preview-name-privacy"></span></p>
                    </div>
                </div>
                <div style="background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="background: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                            <span>âœ¨</span> Hey <span id="preview-name"></span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: var(--text-gray); margin-bottom: 8px;">
                        To: <span id="preview-email" style="color: var(--text-dark);"></span>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 16px; font-style: italic; color: var(--text-dark);">
                        ðŸ’› "<span id="preview-message"></span>"
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-white" style="flex: 1;" onclick="hidePreviewModal()">Cancel</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="confirmSendSmile()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        Send Smile
                    </button>
                </div>
            </div>
        </div>

        {# Sent Messages #}
        <div class="messages-section">
            <h3>Messages sent</h3>

            {% for message in messages %}
                <div class="message-item">
                    {# Desktop Actions - Top Right (hidden on mobile) #}
                    <div class="message-actions-desktop">
                        {# Read/Sent Status Badge with date inside #}
                        {% if message.read_at %}
                            <span style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; background: var(--gray-100); color: var(--gray-600); padding: 0.375rem 0.75rem; border-radius: 9999px; font-weight: 600; font-family: 'Lora', serif;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500);">
                                    <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
                                </svg>
                                Smile created {{ message.sent_at|date('M j') }}
                            </span>
                        {% else %}
                            <span style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; background: var(--gray-100); color: var(--gray-600); padding: 0.375rem 0.75rem; border-radius: 9999px; font-weight: 600; font-family: 'Lora', serif;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500);">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                                Sent {{ message.sent_at|date('M j') }}
                            </span>
                        {% endif %}

                        {# Preview button hidden for now - users were clicking to increment smile count #}
                        <button class="message-action-btn preview" onclick="previewMessage('{{ message.message_url }}')" title="Preview" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                        <button class="message-action-btn delete" onclick="deleteMessage({{ message.id }})" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>

                    <div style="position: relative; margin-bottom: 1.5rem;">
                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(to right, var(--orange-100), var(--pink-100)); padding: 0.5rem 1rem; border-radius: 9999px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--orange-600);">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <span style="font-size: 0.875rem; font-weight: 600; color: var(--orange-900);">
                                Hey {{ message.recipient_name }}
                                <span style="color: var(--gray-500); font-weight: 400; margin-left: 0.25rem;">Â· {{ message.recipient_email }}</span>
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div class="message-emoji">ðŸ’›</div>
                        <p class="message-text">"{{ message.message }}"</p>
                    </div>

                    {# Mobile Actions - Bottom with Border (hidden on desktop) #}
                    <div class="message-actions-mobile">
                        {# Status Badge #}
                        {% if message.read_at %}
                            <span style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; background: var(--gray-100); color: var(--gray-600); padding: 0.375rem 0.75rem; border-radius: 9999px; font-weight: 600; font-family: 'Lora', serif;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500);">
                                    <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
                                </svg>
                                Smile created {{ message.sent_at|date('M j') }}
                            </span>
                        {% else %}
                            <span style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; background: var(--gray-100); color: var(--gray-600); padding: 0.375rem 0.75rem; border-radius: 9999px; font-weight: 600; font-family: 'Lora', serif;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500);">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                                Sent {{ message.sent_at|date('M j') }}
                            </span>
                        {% endif %}

                        {# Action Buttons #}
                        <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                            {# Preview button hidden for now - users were clicking to increment smile count #}
                            <button class="message-action-btn preview" onclick="previewMessage('{{ message.message_url }}')" title="Preview" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                            <button class="message-action-btn delete" onclick="deleteMessage({{ message.id }})" title="Delete">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% else %}
                <p style="text-align: center; color: var(--text-gray); padding: 40px 0;">No messages sent yet. Create your first one above!</p>
            {% endfor %}
        </div>
    </div>
</div>

{# Include stat modals from homepage #}
{% include 'stats-modals.twig' %}
{% endblock %}

{% block scripts %}
<script>
// Store user info in localStorage for "logged in" feel
(function() {
    const currentUrl = window.location.pathname;
    if (currentUrl.includes('/dashboard/')) {
        const dashboardUrl = window.location.origin + currentUrl.split('?')[0];
        localStorage.setItem('myDashboardUrl', dashboardUrl);
        localStorage.setItem('myName', '{{ sender.name }}');
        localStorage.setItem('myEmail', '{{ sender.email }}');
        localStorage.setItem('myAvatar', '{{ sender.avatar }}');
    }
})();

// User dropdown toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('user-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown && !e.target.closest('[onclick="toggleUserDropdown()"]') && !e.target.closest('#user-dropdown')) {
        dropdown.style.display = 'none';
    }
});

// Sign out function
function signOut() {
    localStorage.removeItem('myDashboardUrl');
    localStorage.removeItem('myName');
    localStorage.removeItem('myEmail');
    localStorage.removeItem('myAvatar');
    window.location.href = '/';
}

// Store form data for preview
let pendingSmileData = null;

// Send form - show preview modal first
document.getElementById('send-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    pendingSmileData = {
        recipient_name: formData.get('recipient_name'),
        recipient_email: formData.get('recipient_email'),
        message: formData.get('message')
    };

    // Show preview modal with privacy info
    document.getElementById('preview-name').textContent = pendingSmileData.recipient_name;
    document.getElementById('preview-name-privacy').textContent = pendingSmileData.recipient_name;
    document.getElementById('preview-email').textContent = pendingSmileData.recipient_email;
    document.getElementById('preview-message').textContent = pendingSmileData.message;
    document.getElementById('preview-modal').classList.remove('hidden');
});

// Hide preview modal
function hidePreviewModal() {
    document.getElementById('preview-modal').classList.add('hidden');
    pendingSmileData = null;
}

// Confirm and actually send the smile
async function confirmSendSmile() {
    if (!pendingSmileData) return;

    try {
        const dashboardUrl = window.location.pathname.split('/').pop();
        const response = await fetch(`/api/dashboard/${dashboardUrl}/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pendingSmileData)
        });

        const result = await response.json();

        if (result.success) {
            hidePreviewModal();
            location.reload();
        } else {
            hidePreviewModal();
            if (result.needs_confirmation) {
                // Show confirmation prompt
                if (confirm(result.error + '\n\nWould you like to send a confirmation email now?')) {
                    await requestConfirmation();
                }
            } else {
                alert(result.error || 'Failed to send. Please try again.');
            }
        }
    } catch (error) {
        console.error('Send error:', error);
        hidePreviewModal();
        alert('An error occurred. Please try again.');
    }
}

// Request email confirmation
async function requestConfirmation() {
    try {
        const dashboardUrl = window.location.pathname.split('/').pop();
        const response = await fetch(`/api/dashboard/${dashboardUrl}/request-confirmation`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert('Confirmation email sent! Check your inbox to unlock unlimited Smiles.');
        } else {
            alert('Failed to send confirmation email. Please try again.');
        }
    } catch (error) {
        console.error('Request confirmation error:', error);
        alert('An error occurred. Please try again.');
    }
}

// Request email confirmation from banner button
async function requestConfirmationEmail() {
    try {
        const dashboardUrl = window.location.pathname.split('/').pop();
        const response = await fetch(`/api/dashboard/${dashboardUrl}/request-confirmation`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert('Confirmation email sent! Check your inbox to unlock unlimited Smiles.');
        } else {
            alert('Failed to send confirmation email. Please try again.');
        }
    } catch (error) {
        console.error('Request confirmation error:', error);
        alert('An error occurred. Please try again.');
    }
}

// Preview message
function previewMessage(messageUrl) {
    window.open(`/s/${messageUrl}`, '_blank');
}

// Delete message
async function deleteMessage(id) {
    if (!confirm('Delete this Smile?')) return;

    try {
        const response = await fetch(`/api/messages/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert('Failed to delete');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('An error occurred');
    }
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('URL copied to clipboard!');
    });
}

// Make company smiles stat clickable
document.addEventListener('DOMContentLoaded', function() {
    const companyStat = document.getElementById('company-smiles-stat');
    if (companyStat) {
        const company = companyStat.getAttribute('data-company');
        if (company) {
            companyStat.addEventListener('click', function() {
                showWithinCompanyModal(company);
            });
        }
    }
});
</script>
{% endblock %}
