{% extends "layout.twig" %}

{% block body %}
{# Gradient Header Bar #}
<div class="gradient-header">
    <div class="gradient-header-content">
        <a href="/" class="logo">1 Trillion Smiles</a>
        <div class="header-stats">
            <div class="header-stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <span><strong>{{ global_smiles|number_format }}</strong> of 1T smiles</span>
            </div>
            {% if company %}
            <div class="header-stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
                </svg>
                <span><strong>{{ company_smiles }}</strong> {{ company }} smiles</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div style="background: var(--bg-light); min-height: calc(100vh - 64px); padding: 32px 0;">
    <div class="container-narrow">
        {# Welcome Banner (First Visit) #}
        {% if first_visit %}
        <div class="banner banner-success">
            <button class="banner-close" onclick="this.parentElement.remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <h4>Welcome to your Smile page!</h4>
            <p>This page keeps track of Smiles you've sent and how many Smiles you've created on others. Check your email to confirm it's really you and to easily get back to this page.</p>
        </div>
        {% endif %}

        {# Email Confirmation Banner #}
        {% if not sender.email_confirmed %}
        <div class="banner banner-warning">
            <h4>ðŸ“§ Confirm your email</h4>
            <p>You can send {{ 3 - message_count }} more Smiles before confirming. Check your email to unlock unlimited Smiles!</p>
        </div>
        {% endif %}

        {# Profile Header #}
        <div class="profile-header">
            <div class="profile-info">
                <div class="profile-avatar">{{ sender.avatar }}</div>
                <div class="profile-details">
                    <h2>{{ sender.name }}</h2>
                    <p class="profile-email">{{ sender.email }}</p>
                    <div class="profile-url">
                        <span>{{ dashboard_url }}</span>
                        <button onclick="copyToClipboard('{{ dashboard_url }}')" title="Copy URL">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stats-number">{{ smile_count }}</div>
                <div class="profile-stats-label">smiles created</div>
            </div>
        </div>

        {# Send Smile Form #}
        <div class="message-form-card">
            <h3>Send smile</h3>
            <form id="send-form">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" name="recipient_name" class="form-input" placeholder="Sarah" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="recipient_email" class="form-input" placeholder="sarah@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Your message</label>
                    <textarea name="message" class="form-textarea" placeholder="Write something that will make them smile..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Send smile
                </button>
            </form>
        </div>

        {# Sent Messages #}
        <div class="messages-section">
            <h3>Smiles sent</h3>

            {% for message in messages %}
                <div class="message-item">
                    <div class="message-item-header">
                        <div class="message-badge">
                            <span>âœ¨</span>
                            Hey {{ message.recipient_name }}
                        </div>
                        <div class="message-actions">
                            <span class="message-date">Smile created {{ message.sent_at|date('M j') }}</span>
                            {% if message.read_at %}
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" title="Viewed">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            {% endif %}
                            <button class="message-action-btn" onclick="deleteMessage({{ message.id }})" title="Delete">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="message-text">ðŸ’› "{{ message.message }}"</p>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">{{ message.recipient_email }}</p>
                </div>
            {% else %}
                <p style="text-align: center; color: var(--text-gray); padding: 40px 0;">No Smiles sent yet. Send your first one above! âœ¨</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Send form
document.getElementById('send-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
        recipient_name: formData.get('recipient_name'),
        recipient_email: formData.get('recipient_email'),
        message: formData.get('message')
    };

    try {
        const response = await fetch(window.location.pathname + '/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert('Smile sent! âœ¨');
            location.reload();
        } else {
            alert(result.error || 'Failed to send. Please try again.');
        }
    } catch (error) {
        console.error('Send error:', error);
        alert('An error occurred. Please try again.');
    }
});

// Delete message
async function deleteMessage(id) {
    if (!confirm('Delete this Smile?')) return;

    try {
        const response = await fetch(`/api/messages/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert('Failed to delete');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('An error occurred');
    }
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('URL copied to clipboard!');
    });
}
</script>
{% endblock %}
