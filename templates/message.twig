{% extends "layout.twig" %}

{% block body %}
{# Gradient Header Bar #}
<div class="gradient-header">
    <div class="gradient-header-content">
        <a href="/" class="logo">1 Trillion Smiles</a>
        <div class="header-stats">
            <div class="header-stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <span><strong>{{ global_smiles|number_format }}</strong> of 1T smiles</span>
            </div>
            {% if company %}
            <div class="header-stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
                </svg>
                <span><strong>{{ company_smiles }}</strong> {{ company }} smiles</span>
            </div>
            {% endif %}
            <button class="btn btn-white btn-sm" onclick="window.location.href='/#signup'">Start Spreading Smiles</button>
        </div>
    </div>
</div>

<div style="background: var(--bg-light); min-height: calc(100vh - 64px); padding: 32px 0;">
    <div class="container-narrow">
        {# Message Hero Card #}
        <div class="message-hero">
            <div class="message-badge-large">
                <span>âœ¨</span>
                Hey {{ message.recipient_name }}
            </div>

            <div class="message-emoji">ğŸ’›</div>

            <p class="message-content">"{{ message.message }}"</p>

            <div class="message-sender-card">
                <div class="message-sender-avatar">{{ sender.avatar }}</div>
                <div class="message-sender-info">
                    <h4>{{ sender.name }}</h4>
                    <p>Has created {{ sender_smile_count }} smile{{ sender_smile_count != 1 ? 's' : '' }} âœ¨</p>
                </div>
            </div>
        </div>

        {# Treasure Hunt Section #}
        <div class="treasure-hunt-card">
            <h3>Curious what else {{ sender.name }} said?</h3>
            <p>{{ sender.name }} sent Smiles to others too. Enter an email to peek at their Smile ğŸ‘€</p>
            <div class="lookup-form">
                <input
                    type="email"
                    id="lookup-email"
                    class="form-input"
                    placeholder="someone@example.com"
                    style="flex: 1;"
                >
                <button class="btn btn-primary" onclick="lookupMessage()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    Look up
                </button>
            </div>

            <div id="lookup-result" class="hidden lookup-result"></div>
        </div>

        {# CTA Card #}
        <div class="cta-card">
            <h2>What is One Trillion Smiles?</h2>
            <p>Smiles are heartfelt messages you send that create happiness and make people's day.</p>
            <button class="btn btn-white btn-lg" onclick="window.location.href='/'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Start Spreading Smiles
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function lookupMessage() {
    const email = document.getElementById('lookup-email').value.trim();
    if (!email) return;

    try {
        const response = await fetch('/api/sender/{{ sender.id }}/lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });

        const result = await response.json();
        const resultDiv = document.getElementById('lookup-result');

        if (result.success && result.messages.length > 0) {
            resultDiv.innerHTML = result.messages.map(msg => `
                <div style="margin-bottom: 1rem;">
                    <p style="font-weight: 600; color: var(--orange); font-size: 14px; margin-bottom: 8px;">
                        Smile to ${email.split('@')[0]}:
                    </p>
                    <p style="color: var(--text-dark); font-style: italic;">"${msg.message}"</p>
                </div>
            `).join('');
            resultDiv.classList.remove('hidden');
        } else {
            resultDiv.innerHTML = '<p style="color: var(--text-gray); text-align: center;">No Smile found for this email ğŸ¤·â€â™€ï¸</p>';
            resultDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Lookup error:', error);
        alert('An error occurred. Please try again.');
    }
}
</script>
{% endblock %}
