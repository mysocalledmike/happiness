{% extends "layout.twig" %}

{% block body %}
{# Gradient Header Bar #}
<div class="gradient-header">
    <div class="gradient-header-content">
        <a href="/{% if company %}?company={{ company }}{% endif %}" class="logo">
            One Trillion Smiles
            <div class="logo-underline">
                <div class="logo-underline-line"></div>
                <div class="logo-sparkle">âœ¨</div>
                <div class="logo-underline-line"></div>
            </div>
        </a>
    </div>
</div>

<div class="page-gradient-bg">
    <div class="message-page-container">
        {# Message Hero Card #}
        <div class="message-hero">
            <div class="message-badge-large" style="display: inline-flex;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Hey {{ message.recipient_name }}
            </div>

            <div style="display: flex; align-items: flex-start; gap: 1rem; margin-top: 1.5rem; margin-bottom: 2rem;">
                <div style="font-size: 2rem; line-height: 1; flex-shrink: 0;">ğŸ’›</div>
                <p style="font-family: 'Lora', serif; font-size: 2.25rem; line-height: 1.35; color: var(--gray-900); flex: 1; margin: 0; text-align: left;">"{{ message.message }}"</p>
            </div>

            <div style="display: flex; align-items: center; gap: 0.75rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                <div style="width: 3rem; height: 3rem; border-radius: 50%; background: linear-gradient(to bottom right, var(--orange-400), var(--pink-500)); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">{{ sender.avatar }}</div>
                <div>
                    <div style="font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1rem; color: var(--gray-900);">{{ sender.name }}</div>
                    <p style="font-family: 'Lora', serif; font-size: 0.875rem; color: var(--gray-600); margin: 0;" id="sender-smile-count">Has created <span id="smile-count-number">{{ sender_smile_count }}</span> smile<span id="smile-plural">{{ sender_smile_count != 1 ? 's' : '' }}</span> âœ¨</p>
                </div>
            </div>
        </div>

        {# Made Me Smile Button #}
        <div id="smile-button-container" style="margin-top: 2rem; margin-bottom: 3rem; text-align: center;">
            <button id="made-me-smile-btn" class="btn-smile" onclick="recordSmile()">
                <span class="btn-smile-emoji">â˜º</span>
                Let {{ sender.name }} know you smiled
            </button>
        </div>

        {# Celebration Section (shown after clicking smile button) #}
        <div id="smile-celebration" class="hidden" style="background: linear-gradient(to right, #fefce8, #fff7ed); border: 2px solid #fde047; border-radius: 1.5rem; padding: 2rem; text-align: center; margin-bottom: 2rem;">
            <div style="font-size: 4.5rem; margin-bottom: 1rem; animation: rotate-smile 0.5s ease-in-out 2;">
                ğŸ˜Š
            </div>
            <h2 style="font-family: 'Poppins', sans-serif; font-size: 1.875rem; font-weight: 700; color: var(--gray-900); margin-bottom: 1.5rem;">
                You're smiling, which makes {% if company %}{{ company_name }}{% else %}work{% endif %} a happier place!
            </h2>
            <div style="font-size: 3.75rem; font-weight: 700; background: linear-gradient(to right, #ea580c, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: 'Poppins', sans-serif; margin-bottom: 1rem;" id="celebration-count">
                0
            </div>
            <p style="font-family: 'Lora', serif; font-size: 1.25rem; color: var(--gray-700);">
                We've created <span id="celebration-count-text">0</span> smiles at {% if company %}{{ company_name }}{% else %}your company{% endif %} so far! ğŸ‰
            </p>
        </div>

        {# New Message Compose Card (shown after clicking smile button) #}
        <div id="quick-send-section" class="hidden">
            <div class="compose-card">
                <h2 class="pass-it-along-heading">Now pass it along</h2>

                <form id="quick-send-message-form">
                    {# Pink bubble with Name and Email inputs #}
                    <div class="compose-recipient-bubble">
                        <input type="text" name="recipient_name" placeholder="Full name" class="compose-input" required>
                        <input type="email" name="recipient_email" placeholder="Email address" class="compose-input" required>
                    </div>

                    {# Large Message area with emoji #}
                    <div class="compose-message-area">
                        <div class="compose-emoji">ğŸ’›</div>
                        <textarea name="message" id="message-compose-textarea" class="compose-textarea" placeholder="Write something that will make them smile..." required></textarea>
                    </div>

                    {# Bottom action bar #}
                    <div class="compose-actions">
                        <button type="button" onclick="handleNeedIdeasMessage()" class="compose-ideas-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18h6M12 2a7 7 0 0 1 7 7c0 2.4-1.2 4.5-3 5.7V17a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-2.3C6.2 13.5 5 11.4 5 9a7 7 0 0 1 7-7z"/>
                            </svg>
                            Need ideas?
                        </button>
                        <button type="submit" class="compose-send-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                            Send message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{# Traits Modal #}
<div id="message-traits-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 42rem; max-height: 80vh; overflow-y: auto;">
        <button class="modal-close" onclick="hideMessageTraitsModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.5rem;">âœ¨</span>
                <h3 style="font-family: 'Poppins', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">Still stuck?</h3>
            </div>
            <p style="font-family: 'Lora', serif; color: var(--gray-600);">What's one trait that makes this person awesome?</p>
        </div>
        <div class="traits-grid">
            <button class="trait-btn" onclick="selectMessageTrait('leadership')">ğŸ¯ Leadership</button>
            <button class="trait-btn" onclick="selectMessageTrait('empathy')">ğŸ’™ Empathy</button>
            <button class="trait-btn" onclick="selectMessageTrait('creativity')">âœ¨ Creativity</button>
            <button class="trait-btn" onclick="selectMessageTrait('reliability')">âš¡ Reliability</button>
            <button class="trait-btn" onclick="selectMessageTrait('collaboration')">ğŸ¤ Collaboration</button>
            <button class="trait-btn" onclick="selectMessageTrait('positivity')">â˜€ï¸ Positivity</button>
            <button class="trait-btn" onclick="selectMessageTrait('mentorship')">ğŸŒ± Mentorship</button>
            <button class="trait-btn" onclick="selectMessageTrait('humor')">ğŸ˜„ Humor</button>
            <button class="trait-btn" onclick="selectMessageTrait('patience')">ğŸ§˜ Patience</button>
            <button class="trait-btn" onclick="selectMessageTrait('innovation')">ğŸ’¡ Innovation</button>
            <button class="trait-btn" onclick="selectMessageTrait('kindness')">ğŸ’ Kindness</button>
            <button class="trait-btn" onclick="selectMessageTrait('expertise')">ğŸ“ Expertise</button>
            <button class="trait-btn" onclick="selectMessageTrait('listening')">ğŸ‘‚ Listening</button>
            <button class="trait-btn" onclick="selectMessageTrait('courage')">ğŸ¦ Courage</button>
            <button class="trait-btn" onclick="selectMessageTrait('generosity')">ğŸ Generosity</button>
            <button class="trait-btn" onclick="selectMessageTrait('authenticity')">ğŸ’ Authenticity</button>
        </div>
    </div>
</div>

{# Include stat modals #}
{% include 'stats-modals.twig' %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script>
let smileRecorded = false;

// Writing prompts
const writingPrompts = [
    "Write something that will make them smile...",
    "You made my week when you...",
    "I'll never forget when you...",
    "Working with you taught me...",
    "Your support really helped me when...",
    "I appreciate how you always...",
    "One thing I admire about you is...",
    "You inspired me when...",
    "I'm grateful for the time you..."
];

// Trait-specific prompts
const traitPrompts = {
    leadership: "Tell them about a specific time their leadership made a difference for the team...",
    empathy: "Tell them about a moment when their empathy helped during a difficult time...",
    creativity: "Tell them about a creative solution or idea they brought that really stood out...",
    reliability: "Tell them how their reliability has made an impact - when did it matter most?",
    collaboration: "Tell them about a favorite project or moment collaborating with them...",
    positivity: "Tell them about a time their positive energy lifted the team up...",
    mentorship: "Tell them something important they taught or helped others learn...",
    humor: "Tell them about a time their sense of humor brightened the day or lightened a tough situation...",
    patience: "Tell them about a time their patience really made a difference...",
    innovation: "Tell them about an innovative approach or fresh perspective they brought...",
    kindness: "Tell them about a time they showed kindness that really meant something...",
    expertise: "Tell them what aspect of their expertise or skill has been most valuable...",
    listening: "Tell them about a time they really listened and made someone feel heard...",
    courage: "Tell them about a time they showed courage that inspired the team...",
    generosity: "Tell them how they've been generous with their time, knowledge, or support...",
    authenticity: "Tell them what stands out about how genuine and authentic they are..."
};

// Prompt cycling state for message page
let messagePromptClickCount = 0;
let messageHasSeenModal = false;

// Handle "Need ideas?" button click on message page
function handleNeedIdeasMessage() {
    const textarea = document.getElementById('message-compose-textarea');

    // If user has already seen the modal, always show it
    if (messageHasSeenModal) {
        showMessageTraitsModal();
        return;
    }

    messagePromptClickCount++;

    if (messagePromptClickCount >= 8) {
        showMessageTraitsModal();
    } else {
        textarea.placeholder = writingPrompts[messagePromptClickCount % writingPrompts.length];
    }
}

// Show/hide traits modal on message page
function showMessageTraitsModal() {
    messageHasSeenModal = true;
    document.getElementById('message-traits-modal').classList.remove('hidden');
}

function hideMessageTraitsModal() {
    document.getElementById('message-traits-modal').classList.add('hidden');
}

// Select a trait on message page
function selectMessageTrait(traitId) {
    const textarea = document.getElementById('message-compose-textarea');
    textarea.placeholder = traitPrompts[traitId];
    hideMessageTraitsModal();
}

// Close traits modal when clicking outside
document.getElementById('message-traits-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        hideMessageTraitsModal();
    }
});

// Record smile when button is clicked
async function recordSmile() {
    if (smileRecorded) return;

    const btn = document.getElementById('made-me-smile-btn');
    btn.disabled = true;

    try {
        const messageUrl = window.location.pathname.split('/').pop();
        const response = await fetch(`/api/messages/${messageUrl}/smile`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            smileRecorded = true;

            // Update smile counts in UI
            document.getElementById('smile-count-number').textContent = result.sender_smile_count;
            document.getElementById('smile-plural').textContent = result.sender_smile_count != 1 ? 's' : '';

            // Trigger confetti
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FF6B6B', '#FFD93D', '#6BCF7F', '#4ECDC4', '#95E1D3']
            });

            // Show celebration section
            const celebrationSection = document.getElementById('smile-celebration');
            celebrationSection.classList.remove('hidden');

            // Animate counter from 0 to company_smiles
            const companySmiles = {{ company_smiles|default(0) }};
            let current = 0;
            const duration = 2000;
            const increment = companySmiles / (duration / 16);

            const timer = setInterval(() => {
                current += increment;
                if (current >= companySmiles) {
                    document.getElementById('celebration-count').textContent = companySmiles.toLocaleString();
                    document.getElementById('celebration-count-text').textContent = companySmiles.toLocaleString();
                    clearInterval(timer);
                } else {
                    const rounded = Math.floor(current);
                    document.getElementById('celebration-count').textContent = rounded.toLocaleString();
                    document.getElementById('celebration-count-text').textContent = rounded.toLocaleString();
                }
            }, 16);

            // Hide button and show quick send section
            document.getElementById('smile-button-container').style.display = 'none';
            document.getElementById('quick-send-section').classList.remove('hidden');

            // Scroll to the celebration section
            setTimeout(() => {
                celebrationSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        } else {
            alert(result.error || 'Failed to record smile');
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Record smile error:', error);
        alert('An error occurred. Please try again.');
        btn.disabled = false;
    }
}

// Handle form submission - no confirmation, just send and redirect
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('quick-send-message-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const messageData = {
            sender_name: '{{ message.recipient_name }}',
            sender_email: '{{ message.recipient_email }}',
            recipient_name: formData.get('recipient_name'),
            recipient_email: formData.get('recipient_email'),
            message: formData.get('message')
        };

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin"><circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/></svg> Sending...';

        try {
            const response = await fetch('/api/messages/quick-send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(messageData)
            });

            const result = await response.json();

            if (result.success) {
                // Redirect to dashboard with smile_sent flag
                window.location.href = `/dashboard/${result.dashboard_url}?smile_sent=1`;
            } else {
                alert(result.error || 'Failed to send. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send message';
            }
        } catch (error) {
            console.error('Quick send error:', error);
            alert('An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send message';
        }
    });

    // Auto-grow textarea
    document.getElementById('message-compose-textarea')?.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
});
</script>
{% endblock %}
