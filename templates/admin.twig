{% extends "layout.twig" %}

{% block body %}
<div style="min-height: 100vh; background: #f9fafb; padding: 2rem;">
    <div style="max-width: 1400px; margin: 0 auto;">
        <div style="background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h1 class="font-poppins" style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 2rem;">
                Admin Dashboard
            </h1>

            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb;">
                            <th style="text-align: left; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Name</th>
                            <th style="text-align: left; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Email</th>
                            <th style="text-align: center; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Confirmed</th>
                            <th style="text-align: center; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Messages</th>
                            <th style="text-align: center; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Smiles</th>
                            <th style="text-align: left; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Created</th>
                            <th style="text-align: right; padding: 1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #374151;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: linear-gradient(135deg, #fb923c, #ec4899); display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                        {{ user.avatar }}
                                    </div>
                                    <span class="font-poppins" style="font-weight: 600; color: #1f2937;">{{ user.name }}</span>
                                </div>
                            </td>
                            <td style="padding: 1rem;">
                                <span class="font-lora" style="color: #6b7280;">{{ user.email }}</span>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                {% if user.email_confirmed %}
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 50%; background: #d1fae5;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                    </span>
                                {% else %}
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 50%; background: #fee2e2;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="3">
                                            <path d="M18 6L6 18M6 6l12 12"/>
                                        </svg>
                                    </span>
                                {% endif %}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <span class="font-poppins" style="font-weight: 600; color: #1f2937;">{{ user.message_count }}</span>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <span class="font-poppins" style="font-weight: 600; color: #fb923c;">{{ user.smiles_created }}</span>
                            </td>
                            <td style="padding: 1rem;">
                                <span class="font-lora" style="font-size: 0.875rem; color: #6b7280;">{{ user.created_at|date('M j, Y') }}</span>
                            </td>
                            <td style="padding: 1rem;">
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button
                                        onclick="sendReminder('{{ user.email }}')"
                                        class="btn btn-sm"
                                        style="background: #f3f4f6; color: #6b7280; border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer;"
                                        title="Send Reminder"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                            <polyline points="22,6 12,13 2,6"/>
                                        </svg>
                                    </button>
                                    <button
                                        onclick="resetDashboard('{{ user.email }}')"
                                        class="btn btn-sm"
                                        style="background: #f3f4f6; color: #6b7280; border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer;"
                                        title="Reset Dashboard URL"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                        </svg>
                                    </button>
                                    <button
                                        onclick="deleteUser('{{ user.email }}')"
                                        class="btn btn-sm"
                                        style="background: #fef2f2; color: #ef4444; border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer;"
                                        title="Delete User"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" style="padding: 3rem; text-align: center;">
                                <p class="font-lora" style="color: #6b7280;">No users yet</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function sendReminder(email) {
    if (!confirm(`Send reminder email to ${email}?`)) return;

    try {
        const response = await fetch('/api/admin/send-reminder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });

        const result = await response.json();

        if (result.success) {
            alert('Reminder sent!');
        } else {
            alert('Error: ' + (result.message || 'Failed to send reminder'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}

async function resetDashboard(email) {
    if (!confirm(`Reset dashboard URL for ${email}? Their old link will stop working.`)) return;

    try {
        const response = await fetch('/api/admin/reset-creation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });

        const result = await response.json();

        if (result.success) {
            alert('Dashboard URL reset! They will receive an email with the new link.');
        } else {
            alert('Error: ' + (result.message || 'Failed to reset'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}

async function deleteUser(email) {
    if (!confirm(`Delete ${email} and all their messages? This cannot be undone.`)) return;

    try {
        const response = await fetch('/api/admin/delete-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });

        const result = await response.json();

        if (result.success) {
            alert('User deleted');
            location.reload();
        } else {
            alert('Error: ' + (result.message || 'Failed to delete'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}
</script>
{% endblock %}
